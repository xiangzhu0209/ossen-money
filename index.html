<script type="module">
    import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB_H154LeiZ2slCghAzLBy02xxqlT1-0wU",
        authDomain: "ossen-money.firebaseapp.com",
        projectId: "ossen-money",
        storageBucket: "ossen-money.firebasestorage.app",
        messagingSenderId: "910508291691",
        appId: "1:910508291691:web:cf44c7a77a5ea9e878232e",
        measurementId: "G-H1PR0LZZ4Q"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getFirestore(firebaseApp);

    // 1. 先定義好整個 App 的邏輯
    const app = createApp({
        setup() {
            const role = ref(localStorage.getItem('ln_role') || null);
            const pinInput = ref('');
            const loginError = ref(false);
            const isAdmin = computed(() => role.value === 'admin');

            const currentTab = ref('cash'); 
            const currentMonth = ref(new Date().toISOString().slice(0, 7));
            const transactions = ref([]);
            const settings = ref({ cashInitial: 0, accountInitial: 0, customCategories: [] });
            const reconciliations = ref([]);
            const searchQuery = ref('');
            const filterType = ref('all'); 
            
            const amountInput = ref(null);
            const itemInput = ref(null);

            const showSettings = ref(false);
            const showReconcileModal = ref(false);
            const showEditModal = ref(false);
            const showReportModal = ref(false);
            const isSubmitting = ref(false);
            const editingId = ref(null);
            const newCategoryName = ref('');

            const form = ref({
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                amount: '',
                category: '其他',
                item: ''
            });

            const finalCategories = computed(() => {
                const defaults = ['餐飲', '交通', '購物', '娛樂', '醫療', '轉帳', '其他'];
                return [...new Set([...defaults, ...settings.value.customCategories])];
            });

            // 修正過的過濾邏輯
            const filteredEntries = computed(() => {
                return transactions.value.filter(t => {
                    const inMonth = t.date && t.date.startsWith(currentMonth.value);
                    const matchTab = (t.tab || 'cash') === currentTab.value; // 沒標記的預設為 cash
                    const matchType = filterType.value === 'all' || t.type === filterType.value;
                    const matchSearch = (t.item || '').toLowerCase().includes(searchQuery.value.toLowerCase());
                    return inMonth && matchTab && matchType && matchSearch;
                });
            });

            const monthStartBalance = computed(() => {
                const initial = currentTab.value === 'cash' ? (settings.value.cashInitial || 0) : (settings.value.accountInitial || 0);
                const prevTransactions = transactions.value.filter(t => (t.tab || 'cash') === currentTab.value && t.date < currentMonth.value + "-01");
                return prevTransactions.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, initial);
            });

            const monthTotalIncome = computed(() => filteredEntries.value.filter(e => e.type === 'income').reduce((a, b) => a + (Number(b.amount) || 0), 0));
            const monthTotalExpense = computed(() => filteredEntries.value.filter(e => e.type === 'expense').reduce((a, b) => a + (Number(b.amount) || 0), 0));
            const monthEndBalance = computed(() => monthStartBalance.value + monthTotalIncome.value - monthTotalExpense.value);

            onMounted(() => {
                onSnapshot(query(collection(db, "transactions"), orderBy("date", "desc")), (snap) => {
                    transactions.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                });
                onSnapshot(doc(db, "settings", "global"), (d) => {
                    if (d.exists()) settings.value = d.data();
                });
            });

            const submitForm = async () => {
                if (!form.value.item || !form.value.amount || isSubmitting.value) return;
                isSubmitting.value = true;
                try {
                    await addDoc(collection(db, "transactions"), { 
                        ...form.value, 
                        amount: Number(form.value.amount),
                        tab: currentTab.value, 
                        createdAt: new Date() 
                    });
                    form.value.item = ''; 
                    form.value.amount = '';
                } catch (e) { console.error(e); } finally { isSubmitting.value = false; }
            };

            const handleEntryClick = (entry) => {
                if (!isAdmin.value) return;
                editingId.value = entry.id;
                form.value = { ...entry }; 
                showEditModal.value = true;
            };

            const submitEdit = async () => {
                try {
                    const { id, ...updateData } = form.value;
                    updateData.amount = Number(updateData.amount);
                    await updateDoc(doc(db, "transactions", editingId.value), updateData);
                    showEditModal.value = false;
                } catch (e) { console.error(e); }
            };

            const checkPin = () => {
                if (pinInput.value === '8888') { role.value = 'admin'; localStorage.setItem('ln_role', 'admin'); }
                else if (pinInput.value === '1234') { role.value = 'viewer'; localStorage.setItem('ln_role', 'viewer'); }
                else { loginError.value = true; setTimeout(() => loginError.value = false, 2000); }
                pinInput.value = '';
            };

            return {
                role, pinInput, loginError, isAdmin, currentTab, currentMonth, transactions, settings, 
                searchQuery, filterType, showSettings, showReconcileModal, showEditModal, showReportModal,
                isSubmitting, form, editingId, newCategoryName, finalCategories, filteredEntries,
                monthStartBalance, monthTotalIncome, monthTotalExpense, monthEndBalance,
                checkPin, logout: () => { role.value = null; localStorage.removeItem('ln_role'); },
                changeMonth: (val) => {
                    const d = new Date(currentMonth.value + "-01");
                    d.setMonth(d.getMonth() + val);
                    currentMonth.value = d.toISOString().slice(0, 7);
                },
                formatNumber: (n) => Number(n || 0).toLocaleString(),
                formatDateShort: (d) => d ? d.split('-').slice(1).join('/') : '',
                submitForm, handleEntryClick, submitEdit, 
                deleteCurrentEntry: async () => {
                    if (confirm('確定刪除？')) {
                        await deleteDoc(doc(db, "transactions", editingId.value));
                        showEditModal.value = false;
                    }
                }
            };
        }
    });

    // 2. 確定掛載到 #app
    app.mount('#app');
</script>
