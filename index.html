<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ossen è¨˜å¸³ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root { --bg-body: #F5F7FA; --primary: #7B8FA1; --primary-hover: #56697A; --text-main: #2D3748; }
        body { font-family: 'Varela Round', 'Noto Sans TC', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .num-font { font-family: 'Varela Round', sans-serif; font-weight: 600; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E0; border-radius: 4px; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; margin-bottom: 8px; border-radius: 12px; color: #718096; transition: 0.2s; cursor: pointer; font-weight: 500; }
        .nav-item:hover { background-color: #EDF2F7; color: var(--primary); transform: translateX(4px); }
        .nav-item.active { background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(123, 143, 161, 0.3); }
        .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 0; color: #A0AEC0; font-size: 0.75rem; transition: 0.2s; }
        .mobile-nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .mobile-nav-item.active { color: var(--primary); font-weight: bold; }
        .input-std { background: #F7FAFC; border: 1px solid #E2E8F0; border-radius: 10px; padding: 10px 14px; outline: none; width: 100%; transition: 0.2s; }
        .input-std:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(123, 143, 161, 0.1); }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table td { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .report-label { color: #718096; font-size: 0.85rem; }
        .report-val { font-weight: bold; font-family: 'Varela Round'; text-align: right; }
        .reconcile-badge { display: inline-flex; align-items: center; font-size: 0.7rem; color: #059669; background-color: #ECFDF5; padding: 4px 8px; border-radius: 999px; margin-top: 4px; border: 1px solid #A7F3D0; font-weight: bold; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="flex flex-col md:flex-row h-screen w-full">
        <div v-if="!role" class="fixed inset-0 z-50 bg-[#F5F7FA] flex items-center justify-center p-6">
            <div class="bg-white p-8 md:p-10 rounded-[32px] shadow-xl w-full max-w-md text-center">
                <div class="w-20 h-20 bg-[#EDF2F7] rounded-full flex items-center justify-center mx-auto mb-6 text-3xl text-[#7B8FA1]"><i class="fa-solid fa-laptop-file"></i></div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Ossen System</h1>
                <p class="text-gray-400 mb-8 text-sm">è«‹è¼¸å…¥å­˜å–å¯†ç¢¼</p>
                <div class="relative">
                    <input type="password" v-model="pinInput" @keyup.enter="checkPin" placeholder="å¯†ç¢¼" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-4 px-6 text-center text-2xl tracking-[0.5em] font-bold text-gray-700 outline-none focus:border-[#7B8FA1]">
                    <button @click="checkPin" class="absolute right-3 top-3 w-10 h-10 bg-[#7B8FA1] text-white rounded-xl flex items-center justify-center"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
                <p v-if="loginError" class="text-red-400 text-sm mt-4 font-bold animate-bounce">å¯†ç¢¼éŒ¯èª¤</p>
            </div>
        </div>

        <template v-else>
            <aside class="hidden md:flex w-64 bg-white border-r border-gray-200 flex-col flex-shrink-0 z-20">
                <div class="p-8 pb-4">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-shapes text-[#7B8FA1]"></i> Ossen</h1>
                </div>
                <div class="px-4 mb-6">
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <label class="text-xs text-gray-400 font-bold mb-2 block uppercase">æœˆä»½åˆ‡æ›</label>
                        <div class="flex items-center justify-between">
                            <button @click="changeMonth(-1)" class="w-8 h-8 text-gray-400"><i class="fa-solid fa-chevron-left"></i></button>
                            <input type="month" v-model="currentMonth" class="bg-transparent font-bold text-gray-700 text-center w-28 outline-none cursor-pointer">
                            <button @click="changeMonth(1)" class="w-8 h-8 text-gray-400"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <nav class="flex-1 px-4 space-y-1">
                    <div @click="currentTab = 'cash'" :class="['nav-item', currentTab === 'cash' ? 'active' : '']"><i class="fa-solid fa-wallet w-5 mr-3 text-center"></i> ç¾é‡‘å¸³æœ¬</div>
                    <div @click="currentTab = 'account'" :class="['nav-item', currentTab === 'account' ? 'active' : '']"><i class="fa-solid fa-building-columns w-5 mr-3 text-center"></i> éŠ€è¡Œå¸³æˆ¶</div>
                    <div @click="showReportModal = true" class="nav-item hover:text-blue-600 mt-6"><i class="fa-solid fa-chart-pie w-5 mr-3 text-center"></i> è©³ç´°æœˆçµå ±è¡¨</div>
                    <div v-if="isAdmin">
                        <div @click="showReconcileModal = true" class="nav-item hover:text-green-600"><i class="fa-solid fa-clipboard-check w-5 mr-3 text-center"></i> å¸³å‹™æ ¸å°</div>
                        <div @click="showSettings = true" class="nav-item"><i class="fa-solid fa-gear w-5 mr-3 text-center"></i> ç³»çµ±è¨­å®š</div>
                    </div>
                </nav>
                <div class="p-4 border-t border-gray-100"><div @click="logout" class="nav-item text-red-400 hover:bg-red-50 mb-0"><i class="fa-solid fa-right-from-bracket w-5 mr-3 text-center"></i> ç™»å‡º</div></div>
            </aside>

            <main class="flex-1 flex flex-col min-w-0 bg-[#F5F7FA] overflow-hidden">
                <header class="bg-white border-b border-gray-200 px-4 md:px-8 py-3 md:py-4 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm z-10 gap-3 shrink-0">
                    <h2 class="text-xl font-bold text-gray-800">{{ currentTab === 'cash' ? 'ç¾é‡‘å¸³æœ¬' : 'éŠ€è¡Œå¸³æˆ¶' }} <span v-if="role === 'viewer'" class="text-xs bg-orange-100 text-orange-500 px-2 py-0.5 rounded-full ml-2">å”¯è®€</span></h2>
                    <div class="flex flex-col md:flex-row items-center gap-3 w-full md:w-auto">
                        <div class="flex bg-gray-100 rounded-xl p-1 w-full md:w-auto">
                            <button v-for="type in ['all', 'income', 'expense']" :key="type" @click="filterType = type" :class="['flex-1 md:flex-none px-3 py-1.5 text-xs font-bold rounded-lg', filterType === type ? 'bg-white shadow-sm' : 'text-gray-400']">{{ type==='all'?'å…¨éƒ¨':(type==='income'?'æ”¶å…¥':'æ”¯å‡º') }}</button>
                        </div>
                        <div class="relative w-full md:w-64">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-300"></i>
                            <input type="text" v-model="searchQuery" placeholder="æœå°‹èªªæ˜æˆ–é‡‘é¡..." class="w-full bg-gray-100 border-none rounded-xl pl-10 pr-4 py-2.5 text-sm focus:bg-white transition">
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-24 md:pb-8">
                    <div class="max-w-6xl mx-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                            <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-gray-100 relative">
                                <div class="text-sm text-gray-400 font-medium mb-1">æœ¬æœˆæœŸæœ«é¤˜é¡</div>
                                <div class="text-3xl font-bold text-gray-800 num-font tracking-tight">$ {{ formatNumber(monthEndBalance) }}</div>
                                <div v-if="lastReconciledTime" class="mt-4 text-xs text-green-600 bg-green-50 px-2 py-1 rounded-lg inline-block"><i class="fa-solid fa-check-double mr-1"></i>ä¸Šæ¬¡æ ¸å°: {{ lastReconciledTime }}</div>
                            </div>
                            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 md:col-span-2 flex justify-around items-center">
                                <div class="text-center"><div class="text-xs text-gray-400 mb-1">ä¸Šæœˆçµé¤˜</div><div class="text-lg font-bold text-gray-600 num-font">$ {{ formatNumber(monthStartBalance) }}</div></div>
                                <div class="h-8 w-px bg-gray-200"></div>
                                <div class="text-center"><div class="text-xs text-gray-400 mb-1">æœ¬æœˆæ”¶å…¥</div><div class="text-lg font-bold text-[#95B8A6] num-font">+ {{ formatNumber(monthTotalIncome) }}</div></div>
                                <div class="h-8 w-px bg-gray-200"></div>
                                <div class="text-center"><div class="text-xs text-gray-400 mb-1">æœ¬æœˆæ”¯å‡º</div><div class="text-lg font-bold text-[#D4A5A5] num-font">- {{ formatNumber(monthTotalExpense) }}</div></div>
                            </div>
                        </div>

                        <div v-if="isAdmin" class="hidden md:flex bg-white p-4 rounded-2xl shadow-sm border border-blue-50 flex-wrap items-center gap-3">
                            <div class="bg-blue-50 text-[#7B8FA1] px-3 py-2 rounded-lg font-bold text-sm flex items-center"><i class="fa-solid fa-pen-to-square mr-2"></i> å¿«é€Ÿè¨˜å¸³</div>
                            <input type="date" v-model="form.date" class="input-std w-auto cursor-pointer">
                            <div class="flex bg-gray-100 p-1 rounded-lg">
                                <button @click="form.type = 'expense'" :class="['px-3 py-1.5 rounded-md text-sm font-bold', form.type === 'expense' ? 'bg-white shadow text-[#D4A5A5]' : 'text-gray-400']">æ”¯å‡º</button>
                                <button @click="form.type = 'income'" :class="['px-3 py-1.5 rounded-md text-sm font-bold', form.type === 'income' ? 'bg-white shadow text-[#95B8A6]' : 'text-gray-400']">æ”¶å…¥</button>
                            </div>
                            <input ref="itemInput" type="text" v-model="form.item" placeholder="é …ç›®èªªæ˜..." class="input-std flex-[2]" @keyup.enter="focusAmount">
                            <input ref="amountInput" type="number" v-model.number="form.amount" placeholder="é‡‘é¡" class="input-std w-32 font-bold num-font text-lg" @keyup.enter="submitForm">
                            <select v-model="form.category" class="input-std w-40"><option v-for="cat in finalCategories" :value="cat">{{ cat }}</option></select>
                            <button @click="submitForm" :disabled="isSubmitting" class="w-10 h-10 bg-[#7B8FA1] text-white rounded-lg flex items-center justify-center active:scale-95 transition"><i v-if="isSubmitting" class="fa-solid fa-spinner fa-spin"></i><i v-else class="fa-solid fa-plus"></i></button>
                        </div>
                        <button v-if="isAdmin" @click="showEditModal = true; form = { date: new Date().toISOString().split('T')[0], type: 'expense', amount: '', category: 'å…¶ä»–', item: '' }; editingId = null;" class="md:hidden fixed bottom-24 right-6 w-14 h-14 bg-[#7B8FA1] text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-30"><i class="fa-solid fa-plus"></i></button>

                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <table class="hidden md:table w-full text-left border-collapse">
                                <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider font-semibold border-b">
                                    <tr><th class="p-4">æ—¥æœŸ</th><th class="p-4">é¡å‹</th><th class="p-4">é …ç›®èªªæ˜</th><th class="p-4">é¡åˆ¥</th><th class="p-4 text-right">é‡‘é¡</th><th v-if="isAdmin" class="p-4 w-16 text-center">åˆªé™¤</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    <tr v-for="entry in filteredEntries" :key="entry.id" class="hover:bg-gray-50 transition group">
                                        <td class="p-4 text-gray-500 text-sm font-medium">{{ formatDateShort(entry.date) }}</td>
                                        <td class="p-4"><span :class="['px-2 py-1 rounded text-xs font-bold', entry.type === 'income' ? 'bg-[#95B8A6]/10 text-[#5F8C76]' : 'bg-[#D4A5A5]/10 text-[#C07676]']">{{ entry.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º' }}</span></td>
                                        <td class="p-4"><div @click="handleEntryClick(entry)" class="text-gray-800 font-bold text-sm cursor-pointer hover:underline">{{ entry.item }}</div><div v-if="reconciliationMap[entry.id]" class="reconcile-badge"><i class="fa-solid fa-check mr-1"></i>æ ¸å°çµé¤˜: ${{ formatNumber(reconciliationMap[entry.id].amount) }}</div></td>
                                        <td class="p-4 text-gray-600 text-sm"><span class="bg-gray-100 px-2 py-1 rounded">{{ entry.category }}</span></td>
                                        <td :class="['p-4 text-right font-bold num-font text-base', entry.type === 'income' ? 'text-[#95B8A6]' : 'text-[#D4A5A5]']">{{ entry.type === 'income' ? '+' : '-' }}{{ formatNumber(entry.amount) }}</td>
                                        <td v-if="isAdmin" class="p-4 text-center">
                                            <button @click.stop="deleteEntryDirect(entry.id)" class="text-gray-300 hover:text-red-500 transition-colors p-2"><i class="fa-solid fa-trash-can"></i></button>
                                        </td>
                                    </tr>
                                    <tr v-if="filteredEntries.length === 0"><td colspan="6" class="p-8 text-center text-gray-400 text-sm">å°šç„¡ç´€éŒ„</td></tr>
                                </tbody>
                            </table>
                            <div class="md:hidden divide-y divide-gray-100">
                                <div v-for="entry in filteredEntries" :key="entry.id" class="p-4 active:bg-gray-50">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3" @click="handleEntryClick(entry)">
                                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center shrink-0 text-white text-xs', entry.type==='income'?'bg-[#95B8A6]':'bg-[#D4A5A5]']">{{entry.type==='income'?'æ”¶':'æ”¯'}}</div>
                                            <div><div class="font-bold text-gray-700 text-sm">{{entry.item}}</div><div class="text-xs text-gray-400">{{formatDateShort(entry.date)}} Â· {{entry.category}}</div></div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div :class="['font-bold num-font', entry.type==='income'?'text-[#95B8A6]':'text-[#D4A5A5]']">{{formatNumber(entry.amount)}}</div>
                                            <button v-if="isAdmin" @click.stop="deleteEntryDirect(entry.id)" class="text-red-300 p-2"><i class="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <div class="md:hidden bg-white border-t fixed bottom-0 left-0 w-full flex justify-around z-20 pb-safe">
                <button @click="currentTab='cash'" :class="['mobile-nav-item', currentTab==='cash'?'active':'']"><i class="fa-solid fa-wallet"></i><span>ç¾é‡‘</span></button>
                <button @click="currentTab='account'" :class="['mobile-nav-item', currentTab==='account'?'active':'']"><i class="fa-solid fa-building-columns"></i><span>å¸³æˆ¶</span></button>
                <button @click="showReportModal=true" class="mobile-nav-item"><i class="fa-solid fa-chart-pie"></i><span>å ±è¡¨</span></button>
            </div>
        </template>

        <div v-if="showReportModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-700">æœˆçµå ±è¡¨ <span class="text-sm font-normal text-gray-400">{{ currentMonth }}</span></h3><button @click="showReportModal=false"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <div class="bg-gray-50 p-4 rounded-xl mb-4 text-sm">
                    <table class="report-table">
                        <tr><td class="report-label">ç¾é‡‘ç¸½æ”¶å…¥</td><td class="report-val text-green-600">+ {{ formatNumber(reportStats.cashIncome) }}</td></tr>
                        <tr><td class="report-label">ç¾é‡‘ç¸½æ”¯å‡º</td><td class="report-val text-red-500">- {{ formatNumber(reportStats.cashExpense) }}</td></tr>
                        <tr><td class="report-label font-bold text-gray-700">ç¾é‡‘å¯¦æ”¶</td><td class="report-val text-gray-800 border-t-2 pt-1">{{ formatNumber(reportStats.cashNet) }}</td></tr>
                    </table>
                </div>
                <div class="bg-blue-50/50 p-4 rounded-xl mb-4 text-sm">
                    <table class="report-table">
                        <tr><td class="report-label">å¸³æˆ¶ç¸½æ”¶å…¥</td><td class="report-val text-blue-600">+ {{ formatNumber(reportStats.accountIncome) }}</td></tr>
                        <tr><td class="report-label">å¸³æˆ¶ç¸½æ”¯å‡º</td><td class="report-val text-red-500">- {{ formatNumber(reportStats.accountExpense) }}</td></tr>
                        <tr><td class="report-label font-bold text-gray-700">å¸³æˆ¶å¯¦æ”¶</td><td class="report-val text-gray-800 border-t-2 pt-1">{{ formatNumber(reportStats.accountNet) }}</td></tr>
                    </table>
                </div>
                <div class="bg-[#7B8FA1] text-white p-4 rounded-xl flex justify-between items-center shadow-lg"><span class="font-medium text-sm">æœ¬æœˆç¸½å¯¦æ”¶</span><span class="text-xl font-bold num-font">$ {{ formatNumber(reportStats.totalNet) }}</span></div>
            </div>
        </div>

        <div v-if="showEditModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-700">{{ editingId ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„' }}</h3><button @click="showEditModal=false"><i class="fa-solid fa-xmark text-xl"></i></button></div>
                <div class="space-y-4">
                    <div class="flex bg-gray-100 p-1 rounded-xl">
                        <button @click="form.type='expense'" :class="['flex-1 py-2 rounded-lg text-sm font-bold', form.type==='expense'?'bg-white shadow text-[#D4A5A5]':'text-gray-400']">æ”¯å‡º</button>
                        <button @click="form.type='income'" :class="['flex-1 py-2 rounded-lg text-sm font-bold', form.type==='income'?'bg-white shadow text-[#95B8A6]':'text-gray-400']">æ”¶å…¥</button>
                    </div>
                    <div><label class="text-xs text-gray-400">æ—¥æœŸ</label><input type="date" v-model="form.date" class="input-std"></div>
                    <div><label class="text-xs text-gray-400">å‚™è¨»</label><input type="text" v-model="form.item" class="input-std"></div>
                    <div><label class="text-xs text-gray-400">é‡‘é¡</label><input type="number" v-model.number="form.amount" class="input-std font-bold text-lg"></div>
                    <div><label class="text-xs text-gray-400">é¡åˆ¥</label><select v-model="form.category" class="input-std"><option v-for="cat in finalCategories" :value="cat">{{ cat }}</option></select></div>
                </div>
                <div class="flex gap-4 mt-8"><button @click="deleteEntryDirect(editingId)" class="flex-1 py-3 bg-red-50 text-red-400 rounded-xl font-bold hover:bg-red-100 transition">åˆªé™¤</button><button @click="editingId ? submitEdit() : submitFormMobile()" class="flex-[2] py-3 bg-[#7B8FA1] text-white rounded-xl font-bold">å„²å­˜</button></div>
            </div>
        </div>
        
        <div v-if="showSettings" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl h-[500px] flex flex-col">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-gray-700">ç³»çµ±è¨­å®š</h3><button @click="showSettings=false" class="text-gray-400"><i class="fa-solid fa-xmark"></i></button></div>
                <div class="overflow-y-auto flex-1 pr-2">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">åˆå§‹é‡‘é¡è¨­å®š</h4>
                    <div class="space-y-4 mb-6">
                        <div><label class="text-xs text-gray-400 ml-1">ç¾é‡‘åˆå§‹</label><input type="number" v-model.number="settings.cashInitial" class="input-std font-bold text-lg"></div>
                        <div><label class="text-xs text-gray-400 ml-1">éŠ€è¡Œåˆå§‹</label><input type="number" v-model.number="settings.accountInitial" class="input-std font-bold text-lg"></div>
                    </div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">é¡åˆ¥ç®¡ç†</h4>
                    <div class="flex gap-2 mb-3"><input type="text" v-model="newCategoryName" placeholder="æ–°å¢" class="input-std text-sm"><button @click="addCategory" class="bg-[#7B8FA1] text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button></div>
                    <div class="space-y-2"><div v-for="(cat, idx) in settings.customCategories" :key="idx" class="flex justify-between items-center bg-gray-50 px-3 py-2 rounded-lg text-sm group"><span>{{ cat }}</span><button @click="removeCategory(idx)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>
                </div>
                <div class="pt-4 border-t mt-4"><button @click="saveSettings" class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold shadow-lg shadow-blue-100">ğŸ’¾ å„²å­˜ä¸¦é—œé–‰</button></div>
            </div>
        </div>

        <div v-if="showReconcileModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center">
                <h3 class="text-lg font-bold text-gray-700 mb-6">å¸³å‹™æ ¸å°</h3>
                <div class="bg-gray-50 p-6 rounded-2xl mb-6 border">
                    <div class="text-xs text-gray-400 uppercase tracking-wider">ç³»çµ±è¨ˆç®—é¤˜é¡</div>
                    <div class="text-3xl font-bold num-font text-gray-800 mt-2">$ {{ formatNumber(monthEndBalance) }}</div>
                </div>
                <button @click="addReconciliation" class="w-full py-3.5 rounded-xl font-bold text-white bg-[#95B8A6] shadow-lg shadow-green-100">ç¢ºèªé¤˜é¡ï¼Œæ ¸å°ï¼</button>
                <button @click="showReconcileModal=false" class="mt-4 text-gray-400 text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyB_H154LeiZ2slCghAzLBy02xxqlT1-0wU", authDomain: "ossen-money.firebaseapp.com", projectId: "ossen-money", storageBucket: "ossen-money.firebasestorage.app", messagingSenderId: "910508291691", appId: "1:910508291691:web:cf44c7a77a5ea9e878232e", measurementId: "G-H1PR0LZZ4Q" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const role = ref(localStorage.getItem('ln_role') || null);
                const pinInput = ref('');
                const loginError = ref(false);
                const isAdmin = computed(() => role.value === 'admin');
                const currentTab = ref('cash');
                const currentMonth = ref(new Date().toISOString().slice(0, 7));
                const transactions = ref([]);
                const settings = ref({ cashInitial: 0, accountInitial: 0, customCategories: [] });
                const reconciliations = ref([]);
                const searchQuery = ref('');
                const filterType = ref('all');
                const showSettings = ref(false);
                const showReconcileModal = ref(false);
                const showEditModal = ref(false);
                const showReportModal = ref(false);
                const isSubmitting = ref(false);
                const editingId = ref(null);
                const amountInput = ref(null);
                const itemInput = ref(null);
                const newCategoryName = ref('');
                const defaultCategories = ['å®¢æˆ¶è¨‚é‡‘å°¾æ¬¾', 'è²¨æ¬¾æ”¯å‡º', 'é‹è²»', 'é›œç‰©æ”¯å‡º', 'è–ªè³‡', 'å…¶ä»–'];
                const form = ref({ date: new Date().toISOString().split('T')[0], type: 'expense', amount: '', category: 'å…¶ä»–', item: '' });

                const checkPin = () => { if (pinInput.value === '671213') { role.value = 'admin'; localStorage.setItem('ln_role', 'admin'); } else if (pinInput.value === '45688123') { role.value = 'viewer'; localStorage.setItem('ln_role', 'viewer'); } else { loginError.value = true; pinInput.value = ''; setTimeout(() => loginError.value = false, 2000); } };
                const logout = () => { role.value = null; localStorage.removeItem('ln_role'); };

                // é€£ç·šè®€å–é‚è¼¯ (é–å®š ledger èˆ‡ general è·¯å¾‘)
                onMounted(() => {
                    onSnapshot(query(collection(db, "transactions")), (snap) => { 
                        transactions.value = snap.docs.map(d => { 
                            const data = d.data(); 
                            return { id: d.id, ...data, ledger: data.ledger || data.tab || 'cash' }; 
                        }); 
                    });
                    onSnapshot(doc(db, "settings", "general"), (d) => { if(d.exists()) settings.value = d.data(); });
                    onSnapshot(query(collection(db, "reconciliations")), (snap) => { reconciliations.value = snap.docs.map(d => ({ id: d.id, ...d.data() })); });
                });

                // éæ¿¾èˆ‡è¨ˆç®—é‚è¼¯ (å¼·åŒ–åˆ†é éæ¿¾)
                const filteredEntries = computed(() => {
                    return transactions.value.filter(t => {
                        const matchLedger = t.ledger === currentTab.value;
                        const matchMonth = t.date.startsWith(currentMonth.value);
                        const matchType = filterType.value === 'all' || t.type === filterType.value;
                        const matchSearch = !searchQuery.value || t.item.toLowerCase().includes(searchQuery.value.toLowerCase()) || t.amount.toString().includes(searchQuery.value);
                        return matchLedger && matchMonth && matchType && matchSearch;
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));
                });

                const monthStartBalance = computed(() => { 
                    const init = currentTab.value === 'cash' ? (Number(settings.value?.cashInitial)||0) : (Number(settings.value?.accountInitial)||0); 
                    const prev = transactions.value.filter(t => t.ledger === currentTab.value && t.date < currentMonth.value + "-01"); 
                    return init + prev.reduce((a,b) => a + (b.type==='income'?b.amount:-b.amount), 0); 
                });
                
                const monthTotalIncome = computed(() => filteredEntries.value.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0));
                const monthTotalExpense = computed(() => filteredEntries.value.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0));
                const monthEndBalance = computed(() => monthStartBalance.value + monthTotalIncome.value - monthTotalExpense.value);
                const finalCategories = computed(() => [...defaultCategories, ...(settings.value.customCategories || [])]);
                
                // å®Œæ•´ç‰ˆå ±è¡¨è¨ˆç®—
                const reportStats = computed(() => { 
                    const mt = transactions.value.filter(t => t.date.startsWith(currentMonth.value)); 
                    const calc = (l, ty) => mt.filter(t => t.ledger === l && t.type === ty).reduce((a,b)=>a+b.amount,0); 
                    const cashInc = calc('cash','income'), cashExp = calc('cash','expense');
                    const accInc = calc('account','income'), accExp = calc('account','expense');
                    return { cashIncome: cashInc, cashExpense: cashExp, cashNet: cashInc - cashExp, accountIncome: accInc, accountExpense: accExp, accountNet: accInc - accExp, totalNet: (cashInc - cashExp) + (accInc - accExp) }; 
                });

                const reconciliationMap = computed(() => { const map = {}; reconciliations.value.filter(r => r.ledger === currentTab.value).forEach(r => { if(r.lastTransactionId) map[r.lastTransactionId] = r; }); return map; });
                const lastReconciledTime = computed(() => { const rs = reconciliations.value.filter(r => r.ledger === currentTab.value); return rs.length > 0 ? formatReconcileTime(rs.sort((a,b)=>new Date(b.date)-new Date(a.date))[0].date) : null; });

                const changeMonth = (o) => { const d = new Date(currentMonth.value + "-01"); d.setMonth(d.getMonth() + o); currentMonth.value = d.toISOString().slice(0, 7); };
                const focusAmount = () => amountInput.value.focus();
                
                const submitForm = async () => { if (!form.value.item || !form.value.amount) return; isSubmitting.value = true; await addDoc(collection(db, "transactions"), { ...form.value, ledger: currentTab.value, amount: Number(form.value.amount), createdAt: new Date() }); form.value.amount = ''; form.value.item = ''; isSubmitting.value = false; nextTick(() => itemInput.value.focus()); };
                const submitFormMobile = async () => { await submitForm(); showEditModal.value = false; };
                const handleEntryClick = (e) => { if(isAdmin.value) { editingId.value = e.id; form.value = {...e}; showEditModal.value = true; } };
                const submitEdit = async () => { try { await updateDoc(doc(db, "transactions", editingId.value), { ...form.value, amount: Number(form.value.amount) }); showEditModal.value = false; } catch(e) { alert("ä¿®æ”¹å¤±æ•—"); } };
                
                // ğŸŒŸ ä¿®å¾©å¾Œçš„åˆªé™¤æŒ‡ä»¤ (é—œéµ)
                const deleteEntryDirect = async (id) => { 
                    if(!isAdmin.value) return;
                    if(window.confirm("âš ï¸ ç¢ºå®šè¦ã€Œæ°¸ä¹…åˆªé™¤ã€é€™ç­†ç´€éŒ„å—ï¼Ÿé€™ç„¡æ³•é‚„åŸå–”ï¼")) { 
                        try {
                            await deleteDoc(doc(db, "transactions", id)); 
                            if(showEditModal.value) showEditModal.value = false;
                        } catch(e) { alert("âŒ åˆªé™¤å¤±æ•—: " + e.message); }
                    } 
                };

                const saveSettings = async () => { try { await setDoc(doc(db, "settings", "general"), settings.value); alert("âœ… è¨­å®šå·²å„²å­˜ï¼"); showSettings.value = false; } catch(e) { alert("âŒ å„²å­˜å¤±æ•—"); } };
                const addCategory = () => { if(!newCategoryName.value) return; if(!settings.value.customCategories) settings.value.customCategories = []; settings.value.customCategories.push(newCategoryName.value); newCategoryName.value = ''; };
                const removeCategory = (i) => settings.value.customCategories.splice(i, 1);
                const addReconciliation = async () => { if(!isAdmin.value) return; const latest = filteredEntries.value.length > 0 ? filteredEntries.value[0] : null; await addDoc(collection(db, "reconciliations"), { date: new Date().toISOString(), ledger: currentTab.value, amount: monthEndBalance.value, lastTransactionId: latest ? latest.id : null }); showReconcileModal.value = false; };
                const formatNumber = (num) => new Intl.NumberFormat().format(num || 0);
                const formatDateShort = (s) => { if(!s) return '-'; const d = new Date(s); return `${d.getMonth()+1}/${d.getDate()}`; };
                const formatReconcileTime = (s) => { const d = new Date(s); return `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };

                return { role, isAdmin, pinInput, loginError, checkPin, logout, currentTab, currentMonth, filteredEntries, monthStartBalance, monthTotalIncome, monthTotalExpense, monthEndBalance, reportStats, form, settings, searchQuery, amountInput, itemInput, filterType, showSettings, showReconcileModal, showEditModal, showReportModal, isSubmitting, editingId, finalCategories, newCategoryName, lastReconciledTime, reconciliationMap, changeMonth, submitForm, submitFormMobile, focusAmount, handleEntryClick, submitEdit, deleteEntryDirect, saveSettings, addReconciliation, addCategory, removeCategory, formatNumber, formatDateShort, formatReconcileTime };
            }
        }).mount('#app');
    </script>
</body>
</html>
