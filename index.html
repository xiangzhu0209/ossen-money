<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Little Nook 雲端記帳</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; background-color: #ffffff; }
        .num-font { font-family: 'Courier New', monospace; font-weight: 700; }
        input, select, button { touch-action: manipulation; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-2xl mx-auto min-h-screen flex flex-col bg-gray-50">
        
        <header class="bg-white p-4 shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-xl font-bold text-gray-800">
                    <i class="fa-solid fa-cloud text-blue-600 mr-2"></i>Little Nook 雲端版
                </h1>
                <div class="text-xs text-gray-400">
                    <span v-if="isConnected" class="text-green-500"><i class="fa-solid fa-circle text-[8px] mr-1"></i>已連線</span>
                    <span v-else class="text-red-500">連線中...</span>
                </div>
            </div>
            
            <div class="grid grid-cols-3 border border-gray-200 rounded-lg overflow-hidden text-sm">
                <button @click="currentTab = 'cash'" :class="['py-3 text-center transition', currentTab === 'cash' ? 'tab-active' : 'tab-inactive']">現金</button>
                <button @click="currentTab = 'account'" :class="['py-3 text-center transition', currentTab === 'account' ? 'tab-active' : 'tab-inactive']">帳戶</button>
                <button @click="currentTab = 'report'" :class="['py-3 text-center transition', currentTab === 'report' ? 'tab-active' : 'tab-inactive']">報表</button>
            </div>
        </header>

        <main class="flex-1 p-4 pb-24">
            
            <div v-if="currentTab !== 'report'" class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-blue-100">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="font-bold text-gray-700">{{ currentTab === 'cash' ? '現金' : '銀行帳戶' }}收支</h3>
                    <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-600 font-bold">
                        餘額: <span class="num-font text-lg ml-1">${{ formatNumber(currentBalance) }}</span>
                    </span>
                </div>

                <div class="space-y-3">
                    <div class="flex gap-2">
                        <input type="date" v-model="newEntry.date" class="w-1/3 border rounded-lg p-2 text-sm bg-gray-50">
                        <select v-model="newEntry.category" class="w-2/3 border rounded-lg p-2 text-sm bg-gray-50">
                            <option value="客戶訂金尾款">客戶訂金尾款</option>
                            <option value="貨款支出">貨款支出</option>
                            <option value="運費">運費</option>
                            <option value="雜物支出">雜物支出 (水電/維修)</option>
                            <option value="薪資">薪資/領錢</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>

                    <input type="text" v-model="newEntry.item" placeholder="事項說明 (例如: 廠商名稱)" class="w-full border rounded-lg p-2 text-base focus:ring-2 focus:ring-blue-500 outline-none">
                    
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <span class="absolute left-3 top-2 text-gray-400">$</span>
                            <input type="number" inputmode="numeric" v-model.number="newEntry.amount" placeholder="金額" class="w-full border rounded-lg p-2 pl-6 text-base font-bold text-gray-700 outline-none">
                        </div>
                        <div class="flex rounded-lg overflow-hidden border border-gray-200">
                            <button @click="newEntry.type = 'income'" :class="['px-4 py-2 text-sm font-bold', newEntry.type === 'income' ? 'bg-green-500 text-white' : 'bg-white text-gray-500']">收</button>
                            <button @click="newEntry.type = 'expense'" :class="['px-4 py-2 text-sm font-bold', newEntry.type === 'expense' ? 'bg-red-500 text-white' : 'bg-white text-gray-500']">支</button>
                        </div>
                    </div>
                    
                    <button @click="addEntry" :disabled="isSubmitting" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 rounded-lg shadow-md active:scale-95 transition">
                        <i v-if="isSubmitting" class="fa-solid fa-spinner fa-spin"></i>
                        <span v-else><i class="fa-solid fa-plus"></i> 新增紀錄</span>
                    </button>
                </div>
            </div>

            <div v-if="currentTab !== 'report'" class="space-y-3">
                <div v-for="entry in sortedEntries" :key="entry.id" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs text-gray-400 bg-gray-100 px-1.5 rounded">{{ formatDateShort(entry.date) }}</span>
                            <span class="text-xs text-blue-500 border border-blue-100 px-1.5 rounded">{{ entry.category }}</span>
                        </div>
                        <div class="font-bold text-gray-800">{{ entry.item }}</div>
                        <div class="text-xs text-gray-400">結餘: {{ formatNumber(entry.balance) }}</div>
                    </div>
                    <div class="text-right">
                        <div :class="['text-lg font-bold num-font', entry.type === 'income' ? 'text-green-600' : 'text-red-600']">
                            {{ entry.type === 'income' ? '+' : '-' }}{{ formatNumber(entry.amount) }}
                        </div>
                        <button @click="deleteEntry(entry.id)" class="text-xs text-gray-300 hover:text-red-500 mt-1 p-1">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div v-if="sortedEntries.length === 0" class="text-center text-gray-400 py-10">
                    <i class="fa-solid fa-cloud text-4xl mb-2 opacity-30"></i>
                    <p>尚無雲端紀錄</p>
                </div>
            </div>

            <div v-if="currentTab === 'report'" class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">月結報表</h2>
                    <input type="month" v-model="reportMonth" class="bg-white border rounded px-2 py-1 text-sm">
                </div>
                <div class="grid grid-cols-2 text-center text-sm border-b">
                    <div class="p-3 border-r border-b">
                        <div class="text-gray-500 text-xs">現金收入</div>
                        <div class="text-green-600 font-bold">{{ formatNumber(stats.cashIncome) }}</div>
                    </div>
                    <div class="p-3 border-b">
                        <div class="text-gray-500 text-xs">現金支出</div>
                        <div class="text-red-600 font-bold">{{ formatNumber(stats.cashExpense) }}</div>
                    </div>
                    <div class="p-3 border-r bg-red-50">
                        <div class="text-gray-500 text-xs">現金實收</div>
                        <div class="text-red-700 font-bold num-font text-base">{{ formatNumber(stats.cashNet) }}</div>
                    </div>
                    <div class="p-3 bg-blue-50">
                        <div class="text-gray-500 text-xs">帳戶實收</div>
                        <div class="text-blue-700 font-bold num-font text-base">{{ formatNumber(stats.accountNet) }}</div>
                    </div>
                </div>
                <div class="p-4 bg-green-50 text-center border-b-4 border-green-200">
                    <div class="text-gray-600 text-xs mb-1">本月總實收 (現金+帳戶)</div>
                    <div class="text-2xl font-bold text-green-800 num-font">${{ formatNumber(stats.totalNet) }}</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-100 text-gray-500">
                            <tr>
                                <th class="p-2 whitespace-nowrap">日期</th>
                                <th class="p-2">收/支</th>
                                <th class="p-2">項目</th>
                                <th class="p-2 text-right">金額</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="t in monthlyEntries" :key="t.id">
                                <td class="p-2 text-gray-500">{{ formatDateShort(t.date) }}</td>
                                <td class="p-2"><span :class="['px-1.5 py-0.5 rounded text-[10px]', t.ledger === 'cash' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600']">{{ t.ledger === 'cash' ? '現' : '帳' }}</span></td>
                                <td class="p-2"><div class="font-medium text-gray-700">{{ t.item }}</div><div class="text-[10px] text-gray-400">{{ t.category }}</div></td>
                                <td :class="['p-2 text-right font-bold num-font', t.type === 'income' ? 'text-green-600' : 'text-red-600']">{{ t.type === 'income' ? '' : '-' }}{{ formatNumber(t.amount) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================
        // ▼▼▼ 你的 Firebase 設定 (已自動填入) ▼▼▼
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyB_H154LeiZ2slCghAzLBy02xxqlT1-0wU",
            authDomain: "ossen-money.firebaseapp.com",
            projectId: "ossen-money",
            storageBucket: "ossen-money.firebasestorage.app",
            messagingSenderId: "910508291691",
            appId: "1:910508291691:web:cf44c7a77a5ea9e878232e",
            measurementId: "G-H1PR0LZZ4Q"
        };
        // ============================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const currentTab = ref('cash');
                const transactions = ref([]);
                const isConnected = ref(false);
                const isSubmitting = ref(false);
                
                const today = new Date().toISOString().split('T')[0];
                const newEntry = ref({
                    date: today,
                    item: '',
                    type: 'income',
                    amount: '',
                    category: '客戶訂金尾款',
                    ledger: 'cash'
                });
                
                const reportMonth = ref(today.slice(0, 7));

                // 監聽 Firebase 資料庫變化
                onMounted(() => {
                    const q = query(collection(db, "transactions"), orderBy("createdAt", "desc"));
                    onSnapshot(q, (querySnapshot) => {
                        let temp = [];
                        querySnapshot.forEach((doc) => {
                            temp.push({ id: doc.id, ...doc.data() });
                        });
                        transactions.value = temp;
                        isConnected.value = true;
                    }, (error) => {
                        console.error("Firebase 連線失敗:", error);
                        if (error.code === 'permission-denied') {
                            alert('連線失敗：權限不足。請確認 Firebase Console 的 Rules 已設為測試模式 (allow read, write: if true)。');
                        }
                        isConnected.value = false;
                    });
                });

                const addEntry = async () => {
                    if (!newEntry.value.item || !newEntry.value.amount) return alert("請輸入事項和金額");
                    
                    isSubmitting.value = true;
                    try {
                        await addDoc(collection(db, "transactions"), {
                            date: newEntry.value.date,
                            item: newEntry.value.item,
                            type: newEntry.value.type,
                            amount: newEntry.value.amount,
                            category: newEntry.value.category,
                            ledger: currentTab.value,
                            createdAt: serverTimestamp()
                        });
                        
                        newEntry.value.item = '';
                        newEntry.value.amount = '';
                    } catch (e) {
                        alert("新增失敗: " + e.message);
                    }
                    isSubmitting.value = false;
                };

                const deleteEntry = async (id) => {
                    if(confirm('確定刪除此紀錄？')) {
                        await deleteDoc(doc(db, "transactions", id));
                    }
                };

                const sortedEntries = computed(() => {
                    let list = transactions.value.filter(t => t.ledger === currentTab.value);
                    list.sort((a, b) => new Date(a.date) - new Date(b.date) || (a.createdAt?.seconds - b.createdAt?.seconds));
                    
                    let balance = 0;
                    const listWithBalance = list.map(t => {
                        if (t.type === 'income') balance += t.amount;
                        else balance -= t.amount;
                        return { ...t, balance };
                    });
                    return listWithBalance.reverse();
                });

                const currentBalance = computed(() => {
                    return sortedEntries.value.length > 0 ? sortedEntries.value[0].balance : 0;
                });

                const monthlyEntries = computed(() => {
                    return transactions.value.filter(t => t.date && t.date.startsWith(reportMonth.value))
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                const stats = computed(() => {
                    const list = monthlyEntries.value;
                    const cashList = list.filter(t => t.ledger === 'cash');
                    const accountList = list.filter(t => t.ledger === 'account');
                    const sum = (arr, type) => arr.filter(t => t.type === type).reduce((acc, t) => acc + t.amount, 0);

                    const cashIncome = sum(cashList, 'income');
                    const cashExpense = sum(cashList, 'expense');
                    const cashNet = cashIncome - cashExpense;
                    const accountIncome = sum(accountList, 'income');
                    const accountExpense = sum(accountList, 'expense');
                    const accountNet = accountIncome - accountExpense;

                    return { cashIncome, cashExpense, cashNet, accountNet, totalNet: cashNet + accountNet };
                });

                const formatNumber = (num) => new Intl.NumberFormat().format(num);
                const formatDateShort = (str) => {
                    if(!str) return '';
                    const d = new Date(str);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                };

                return {
                    currentTab, newEntry, addEntry, deleteEntry,
                    sortedEntries, currentBalance,
                    reportMonth, monthlyEntries, stats,
                    formatNumber, formatDateShort, isConnected, isSubmitting
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
